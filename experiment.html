<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">



  <script>
    // elementary only currently
    // TODO: Load parameters based off passed identifier from parameter database
    // TODO: Remove label data
    // TODO: Include formatted reaction
    var parameters = {
      id: 1,
      title: 'Experiment name',
      reactants: [{
          formula: 'NO',
          label0: '[NO] = ',
          label1: ' M',
          id: 'reactant_a',
          concentration: 1.0,
          // ---- //
          order: 0,
          stoichiometric_coefficient: 2,
        },
        {
          formula: 'O2',
          label0: '[O2] = ',
          label1: ' M',
          id: 'reactant_b',
          concentration: 0.6,
          // ---- //
          order: 0,
          stoichiometric_coefficient: 1,
        },
      ],
      products: [{
        formula: 'NO2',
        label0: '[NO2] = ',
        label1: ' M',
        id: 'reactant_c',
        concentration: 0.0,
        // ---- //
        order: 1,
        stoichiometric_coefficient: 2,
      }, ],
      rate_constant: 1,
      // TODO: v2: Include a noise function in a sane way
      noise: function() {
        return 1; //  + (Math.random() - 0.5)*1
      },
    };

    // TODO: inlcude in the same way as the species
    var conditions = {
      t: 0.0,
      dt: 0.01,
      Nmax: 100,
    };

    var data = [];
  </script>

</head>

<body>
  <!-- TODO: Use simple (responsive) box formatting for layout -->
  <!-- TODO: Initialize with moodle user id! -->

  <div class='container border border-dark'>

    <div class='row' class='border border-dark'>
      <div id='header'>
        <h2>There should be a title here</h2>
        <div id='formula'>
          A + B --> C
        </div>
      </div>
    </div>

    <div class='row'>
      <div class='col border border-dark'>

        <div id='experimental_conditions' class='border border-dark'>
          <!-- TODO: refactor to load from config -->
          <!-- <input id='dt' value='0.01'> s<br> -->
          <!-- N<sub>max</sub> = <input id='tmax' value='5000'><br> -->

          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text">&Delta;t = </span>
            </div>
            <input type="text" class="form-control" id='dt' value='0.01'>
            <div class="input-group-append">
              <span class="input-group-text">s</span>
            </div>
          </div>

          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text">N<sub>max</sub> = </span>
            </div>
            <input type="text" class="form-control" input id='tmax' value='100'>
            <!-- <div class="input-group-append"> -->
              <!-- <span class="input-group-text">.00</span> -->
            <!-- </div> -->
          </div>
        </div>

      </div>
      <div class='col border border-dark'>
        <div id='experimental_buttons' class='border border-dark'>
          <!-- TODO: Load from URL parameters -->
          <!-- TDOD: Load from cookie -->
          <button onclick="loadExperiment()" class="btn btn-outline-primary">
            loadExperiment()
          </button>
          <button onclick="loadParameters()" class="btn btn-outline-primary">
            loadParameters()
          </button>
          <button onclick="createEmptyPlot()" class="btn btn-outline-primary">
            createEmptyPlot()
          </button>
          <button onclick="calculateData()" class="btn btn-outline-primary">
            calculateData()
          </button>
          <button onclick="startExperiment()" class="btn btn-outline-primary">
            startExperiment()
          </button>
          <button onclick="" id="stop_experiment_button" class="btn btn-outline-danger">
            stopExperiment()
          </button>
          <button onclick="plotExperiment()" class="btn btn-outline-primary">
            plotExperiment()
          </button>
          <button onclick="getCSVFile()" class="btn btn-outline-success">
            getCSVFile()
          </button>
          <!-- TODO: Reset button -->
        </div>
      </div>
    </div>

    <div class='row'>
      <div id="graph"></div>
    </div>

  </div>


  <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script> -->
  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script> -->

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    // TODO: Rearrange functions into:
    // TODO: * user controllable step functions
    // TODO: * called partial step functions (cuurently button callable)
    // TODO: * organised utility functions
    // TODO: * organised utility data functions


    // <div class="input-group mb-3">
    //   <div class="input-group-prepend">
    //     <span class="input-group-text">$</span>
    //   </div>
    //   <input type="text" class="form-control" aria-label="Amount (to the nearest dollar)">
    //   <div class="input-group-append">
    //     <span class="input-group-text">.00</span>
    //   </div>
    // </div>

    function loadExperiment() {
      for (r in parameters.reactants) {

        grp = document.createElement('div');
        grp.classList.add('input-group');
        grp.classList.add('mb-3');

        gd0 = document.createElement('div');
        gd0.classList.add('input-group-prepend');

        gt0 = document.createElement('span');
        gt0.classList.add('input-group-text');
        gt0.textContent = parameters.reactants[r].label0;

        inp = document.createElement('input')
        inp.setAttribute('type', 'text');
        inp.value = parameters.reactants[r].concentration;
        inp.id = parameters.reactants[r].id;
        inp.classList.add('form-control')

        gd1 = document.createElement('div');
        gd1.classList.add('input-group-append');

        gt1 = document.createElement('span');
        gt1.classList.add('input-group-text');
        gt1.textContent = parameters.reactants[r].label1;

        // lb0 = document.createTextNode(parameters.reactants[r].label0)
        // lb1 = document.createTextNode(parameters.reactants[r].label1)
        // lbr = document.createElement('br')

        exp = document.getElementById('experimental_conditions');
        exp.appendChild(grp);
        grp.appendChild(gd0);
        gd0.appendChild(gt0);
        grp.appendChild(inp);
        grp.appendChild(gd1);
        gd1.appendChild(gt1);
      }
    }


    function createEmptyPlot() {
      plotly_data = []
      for (r in parameters.reactants) {
        pobj = {
          x: [conditions.t],
          y: [parameters.reactants[r].concentration],
          type: 'scatter',
          name: parameters.reactants[r].formula,
        }
        plotly_data.push(pobj);
      }

      for (p in parameters.products) {
        pobj = {
          x: [conditions.t],
          y: [parameters.products[p].concentration],
          type: 'scatter',
          name: parameters.products[p].formula,
        }
        plotly_data.push(pobj);
      }

      // TODO: v2: Inlcude a reaction rate plot (either concurrent or overlaid in same plot)
      // DEBUG: Reaction rate
      // plotly_data.push({
      //   x: [],
      //   y: [],
      //   type: 'scatter',
      //   name: 's',
      // });
      // to here

      Plotly.plot('graph', plotly_data, {
        //        autosize: true,
        // width: 1000,
      }, {
        responsive: true,
      });
    }

    function loadParameters() {
      for (r in parameters.reactants) {
        parameters.reactants[r].concentration = parseFloat(document.getElementById(parameters.reactants[r].id).value)
      }
      // TODO: v2: When this is all 'species'
      // for (p in parameters.products) {
      //   parameters.products[p].concentration = parseFloat(document.getElementById(parameters.products[p].id).value)
      // }
    }


    function calculateRate(rc) {
      // TODO: v2: Move from reactants & products to species (visible & invisible)
      // TODO: v2: and transition function parameters based off species ids
      s = parameters.rate_constant;
      for (r in parameters.reactants) {
        if (rc[r] > 0) {
          s = s * Math.pow(rc[r], parameters.reactants[r].order);
        } else {
          s = 0;
        }
      }
      return s;
    }


    function calculateData() {
      t = conditions.t;
      c = [];
      for (r in parameters.reactants) {
        // for now, later load from textbox
        c.push(parameters.reactants[r].concentration);
      }
      for (p in parameters.products) {
        // for now, later load from textbox
        c.push(parameters.products[p].concentration);
      }

      s = calculateRate(c);
      // DEBUG: Reaction rate
      // data_line = [t].concat(c, [0]);
      data_line = [t].concat(c);
      data.push(data_line);
      for (i = 1; i < conditions.Nmax; i++) {
        t = t + conditions.dt;
        c_next = [];
        for (r in parameters.reactants) {
          c_next[r] = c[r] - s * conditions.dt * parameters.reactants[r].stoichiometric_coefficient;
          if (c_next[r] < 0) {
            c_next[r] = 0;
          }
        }
        for (p = 0; p < parameters.products.length; p++) {
          c_next[p + parameters.reactants.length] = c[p + parameters.reactants.length] +
            s * conditions.dt * parameters.products[p].stoichiometric_coefficient;
          if (c_next[p + parameters.reactants.length] < 0) {
            c_next[p + parameters.reactants.length] = 0;
          }
        }
        c = c_next;
        s = calculateRate(c);
        data_line = [t].concat(c);
        // DEBUG: Reaction rate
        // data_line = [t].concat(c, s);
        data.push(data_line);
      }
    }


    function plotExperiment() {
      data_x = []
      data_y = []
      for (j = 1; j < data[0].length; j++) {
        temp_x = []
        temp_y = []
        for (i = 0; i < data.length; i++) {
          temp_x.push(data[i][0]);
          temp_y.push(data[i][j]);
        }
        data_x.push(temp_x);
        data_y.push(temp_y);
      }
      Plotly.extendTraces('graph', {
        x: data_x,
        y: data_y,
      }, range(data_x.length));
    }


    function startExperiment() {
      dataslice = getData();
      setIntervalX(function() {
        temp_data = dataslice.next()
        Plotly.extendTraces('graph', {
          x: temp_data.value[0],
          y: temp_data.value[1],
        }, range(temp_data.value[0].length));
      }, 100, conditions.Nmax);
    }


    function* getData(start = 0, end = data.length, step = 1) {
      let iterationCount = 0;
      for (let i = start; i < end; i += step) {
        iterationCount++;
        data_x = []
        data_y = []
        for (j = 1; j < data[i].length; j++) {
          data_x.push([data[i][0]]);
          data_y.push([data[i][j]]);
        }
        yield [data_x, data_y];
      }
      return iterationCount;
    }


    // helper functions
    let range = n => [...Array(n).keys()]


    function setIntervalX(callback, delay, repetitions) {
      var x = 0;
      var intervalID = window.setInterval(function() {
        callback();
        if (++x === repetitions) {
          window.clearInterval(intervalID);
        }
      }, delay);
      document.getElementById('stop_experiment_button').addEventListener('click', function() {
        window.clearInterval(intervalID);
      });
    }


    function getCSVFile() {
      // TODO: Include header
      let csvContent = "data:text/csv;charset=utf-8,";

      data.forEach(function(rowArray) {
        let row = rowArray.join(",");
        csvContent += row + "\r\n";
      });

      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      // TODO: set filename based off data
      link.setAttribute("download", "my_data.csv");
      document.body.appendChild(link); // Required for FF

      link.click();
    }
  </script>

</body>

</html>

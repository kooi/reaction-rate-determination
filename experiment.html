<html>

<head>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


  <script>
    // elementary only currently
    var parameters = {
      id: 1,
      title: 'Experiment name',
      reactants: [{
          formula: 'NO',
          label0: '[NO] = ',
          label1: ' M',
          id: 'reactant_a',
          concentration: 1.0,
          // ---- //
          order: 0,
          stoichiometric_coefficient: 2,
        },
        {
          formula: 'O2',
          label0: '[O2] = ',
          label1: ' M',
          id: 'reactant_b',
          concentration: 0.6,
          // ---- //
          order: 1,
          stoichiometric_coefficient: 1,
        },
      ],
      products: [{
        formula: 'NO2',
        label0: '[NO2] = ',
        label1: ' M',
        id: 'reactant_c',
        concentration: 0.0,
        // ---- //
        order: 1,
        stoichiometric_coefficient: 2,
      }, ],
      rate_constant: 1,
      noise: function() {
        return 1; //  + (Math.random() - 0.5)*1
      },
    };

    var conditions = {
      t: 0.0,
      dt: 0.01,
      Nmax: 5000,
    };

    var data = [];
  </script>

</head>

<body>

  Initialize with moodle user id!

  <div id='experimental_conditions'>
    <!-- <div id='reactants'>
      [A] = <input id='reactant_a_initial'> M<br>
      [B] = <input id='reactant_b_initial'> M<br>
    </div> -->
    &Delta;t = <input id='dt'> s<br>
    N<sub>max</sub> = <input id='tmax'><br>

  </div>

  <!-- <button id='add_random'>getData()</button> -->
  <button onclick="loadExperiment()">
    loadExperiment()
  </button>
  <button onclick="calculateData()">
    calculateData()
  </button>
  <button onclick="startExperiment()">
    startExperiment()
  </button>
  <button onclick="" id="stop_experiment_button">
    stopExperiment()
  </button>
  <button onclick="plotExperiment()">
    plotExperiment()
  </button>
  <button onclick="getCSVFile()">
    getCSVFile()
  </button>

  <div id="graph"></div>

  <script>
    let range = n => [...Array(n).keys()]


    function loadExperiment() {
      plotly_data = []
      // create initial condition input
      for (r in parameters.reactants) {

        lb0 = document.createTextNode(parameters.reactants[r].label0)
        lb1 = document.createTextNode(parameters.reactants[r].label1)
        inp = document.createElement('input')
        lbr = document.createElement('br')
        inp.value = parameters.reactants[r].concentration;
        inp.id = parameters.reactants[r].id;

        exp = document.getElementById('experimental_conditions');
        exp.appendChild(lb0);
        exp.appendChild(inp);
        exp.appendChild(lb1);
        exp.appendChild(lbr);

        pobj = {
          x: [0.0],
          y: [parameters.reactants[r].concentration],
          type: 'scatter',
          name: parameters.reactants[r].formula,
        }
        plotly_data.push(pobj);

      }

      for (p in parameters.products) {
        pobj = {
          x: [0.0],
          y: [parameters.products[p].concentration],
          type: 'scatter',
          name: parameters.products[p].formula,
        }
        plotly_data.push(pobj);
      }

      // add reaction rate
      // plotly_data.push({
      //   x: [],
      //   y: [],
      //   type: 'scatter',
      //   name: 's',
      // });
      // to here

      // plotly plot
      Plotly.plot('graph', plotly_data, {}, {
        responsive: true,
      });


    }

    function calculateRate(rc) {
      // check if len(rc) > len(parameters.reactants)
      // if equal also a problem...
      s = parameters.rate_constant;
      for (r in parameters.reactants) {
        if (rc[r] > 0) {
          s = s * Math.pow(rc[r], parameters.reactants[r].order);
        } else {
          s = 0;
        }
      }
      return s;
    }

    function calculateData() {
      // var conditions = {
      //   t: 0.0,
      //   dt: 0.1,
      //   Nmax: 1000,
      // };

      t = conditions.t;
      c = [];
      for (r in parameters.reactants) {
        // for now, later load from textbox
        c.push(parameters.reactants[r].concentration);
      }
      for (p in parameters.products) {
        // for now, later load from textbox
        c.push(parameters.products[p].concentration);
      }

      // START AT 1!
      // data = [];
      s = calculateRate(c);
      // data_line = [t].concat(c, [0]);
      data_line = [t].concat(c);
      // console.log(data_line);
      data.push(data_line);
      for (i = 1; i < conditions.Nmax; i++) {
        t = t + conditions.dt;
        c_next = [];
        for (r in parameters.reactants) {
          c_next[r] = c[r] - s * conditions.dt * parameters.reactants[r].stoichiometric_coefficient;
          if (c_next[r] < 0) {
            c_next[r] = 0;
          }
        }
        for (p = 0; p < parameters.products.length; p++) {
          c_next[p + parameters.reactants.length] = c[p + parameters.reactants.length] +
            s * conditions.dt * parameters.products[p].stoichiometric_coefficient;
          if (c_next[p + parameters.reactants.length] < 0) {
            c_next[p + parameters.reactants.length] = 0;
          }
        }
        c = c_next;
        s = calculateRate(c);
        data_line = [t].concat(c);
        // data_line = [t].concat(c, s);
        // console.log(data_line);
        data.push(data_line);
      }
    }

    function plotExperiment() {
      data_x = []
      data_y = []
      for (j = 1; j < data[0].length; j++) {
        temp_x = []
        temp_y = []
        for (i = 0; i < data.length; i++) {
          temp_x.push(data[i][0]);
          temp_y.push(data[i][j]);
        }
        data_x.push(temp_x);
        data_y.push(temp_y);
      }
      Plotly.extendTraces('graph', {
        x: data_x,
        y: data_y,
      }, range(data_x.length));
    }

    // plotly 'live' updating
    // do this better...
    function startExperiment() {
      dataslice = getData();
      setIntervalX(function() {
        temp_data = dataslice.next()
        // console.log(temp_data);
        Plotly.extendTraces('graph', {
          // do this live
          x: temp_data.value[0],
          y: temp_data.value[1],
        }, range(temp_data.value[0].length));
      }, 100, conditions.Nmax);
    }

    // experiment functions

    // returns the current timestep worth of data,
    // including any noise is requested
    // make this a generator
    function* getData(start = 0, end = data.length, step = 1) {
      let iterationCount = 0;
      for (let i = start; i < end; i += step) {
        iterationCount++;
        data_x = []
        data_y = []
        for (j = 1; j < data[i].length; j++) {
          data_x.push([data[i][0]]);
          data_y.push([data[i][j]]);
        }
        // console.log([data_x, data_y]);
        yield [data_x, data_y];
      }
      return iterationCount;
    }

    // get this with a yield function....
    // function getData() {
    //   return calcC() + parameters.noise();
    // }

    // function calcC() {
    //   return 0
    //   // calculate rate
    //   // calculate change
    // }


    // helper functions
    function setIntervalX(callback, delay, repetitions) {
      var x = 0;
      var intervalID = window.setInterval(function() {
        callback();
        if (++x === repetitions) {
          window.clearInterval(intervalID);
        }
      }, delay);
      document.getElementById('stop_experiment_button').addEventListener('click', function() {
        window.clearInterval(intervalID);
      });
    }

    function getCSVFile() {
      // const rows = [
      //     ["name1", "city1", "some other info"],
      //     ["name2", "city2", "more info"]
      // ];

      let csvContent = "data:text/csv;charset=utf-8,";

      data.forEach(function(rowArray) {
        let row = rowArray.join(",");
        csvContent += row + "\r\n";
      });

      // var encodedUri = encodeURI(csvContent);
      // window.open(encodedUri);

      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "my_data.csv");
      document.body.appendChild(link); // Required for FF

      link.click(); // This will download the data file named "my_data.csv".
    }
  </script>

</body>

</html>
